# PATCH ЗАДАНИЕ ДЛЯ АГЕНТА (v28.2 UX PARITY — YouGile-like Drawer, Auto-save, Assignees, Labels, Checklist)

**Контекст:** текущая реализация канбана визуально похожа на доску, но не соответствует UX YouGile: нет полноценного открытия карточки в правом Drawer, нет подзадач/чата внутри карточки, нет назначения пользователей из БД, нет управления метками/цветами, приоритет/дедлайн не редактируются или не сохраняются, изменения требуют Enter.

**Цель патча:** довести функционал доски до *YouGile-like поведения* в части карточки и правой панели, с **автосохранением без Enter** и полноценной работой: assignees/labels/checklist/comments/due/priority.

> ВАЖНО: это патч поверх существующего проекта. Не переписывать архитектуру, не вводить лишние сущности. Доделать то, что уже заявлено в v28.1 (Drawer/Offcanvas, чат/комментарии, подзадачи, users/labels, приоритет/дедлайн), и привести UX к критериям ниже.

---

## 0) Критерии готовности (Definition of Done)

### 0.1 Открытие карточки
- **Клик по карточке** на доске **открывает правый Drawer (Bootstrap Offcanvas)**.
- Drawer всегда показывает **данные выбранной карточки** (title, description, priority, due, assignees, labels, checklist, comments).
- Закрытие Drawer не сбрасывает состояние доски (позиции колонок/скролл/поиск).

### 0.2 Вкладки в Drawer (обязательные)
Внутри Drawer реализовать вкладки (Tabs):
1) **Чат** (по умолчанию) — комментарии к карточке
2) **Описание** — редактирование описания (markdown/plain)
3) **Подзадачи** — checklist/подзадачи
4) **Инфо / Лог** — служебные поля (создано/обновлено, автор, id, и т.п.)

### 0.3 Автосохранение без Enter
- Любое изменение полей в Drawer **сохраняется автоматически**:
  - либо `debounce` 300–600 мс на `onChange`,
  - плюс сохранение на `onBlur` (потеря фокуса),
  - Enter **не обязателен** и не является единственным способом сохранить.
- В UI должен быть индикатор состояния:
  - “Сохраняю…” во время запроса,
  - “Сохранено” после успешного ответа,
  - при ошибке — toast/alert + статус “Ошибка сохранения”.

### 0.4 Управляемые приоритет и дедлайн
- **Priority** редактируется (select/segmented: Низкий/Средний/Высокий/Критичный если есть).
- **Due date** редактируется (datetime picker или `input[type=datetime-local]`).
- Изменения реально сохраняются в БД и видны после перезагрузки.

### 0.5 Назначение пользователей (Assignees) из БД
- В Drawer есть блок “Исполнители”:
  - кнопка **“+”** открывает dropdown/модал поиска пользователей,
  - поиск по имени/логину (server-side или client-side если список небольшой),
  - выбор нескольких пользователей,
  - аватарки/инициалы показываются на карточке и в Drawer.
- Назначение/снятие исполнителя сохраняется сразу (auto-save).

### 0.6 Метки/цвета (Labels)
- На карточке отображаются **цветные метки** (chips/badges).
- В Drawer есть управление метками:
  - добавить/удалить метку,
  - создать новую метку (название + цвет из фиксированного enum Bootstrap).
- Изменения меток сохраняются сразу (auto-save).

### 0.7 Подзадачи (Checklist)
- Во вкладке “Подзадачи” реализовать:
  - добавить подзадачу,
  - отметить выполненной,
  - удалить,
  - (опционально) reorder внутри checklist.
- На карточке отображать прогресс: `выполнено/всего` и/или progress bar.
- Состояние подзадач сохраняется сразу (auto-save).

### 0.8 Чат/комментарии
- Во вкладке “Чат”:
  - список комментариев,
  - поле ввода,
  - отправка без Enter-only (кнопка “Отправить” и Enter как удобный шорткат допускается),
  - новые сообщения появляются после отправки и при обновлении (polling 3–10 сек или websocket, минимум polling).
- Комментарии привязаны к карточке, сохраняются в БД.

---

## 1) Обязательные UX детали (как у YouGile)

1) **Клик по карточке** — единственный ожидаемый способ открыть детали (не отдельная кнопка).
2) В Drawer редактирование title/description/due/priority/labels/assignees/checklist работает **без подтверждения Enter**.
3) Drawer должен быть **контекстным**: переключился на другую карточку — Drawer обновился.
4) Если пользователь печатает, смена карточки должна:
   - либо мягко завершать текущий auto-save,
   - либо предупреждать только при явной ошибке (не спрашивать каждый раз).

---

## 2) Минимальные API/Backend требования (если ещё не реализовано)

> Если backend уже имеет похожие эндпоинты — использовать их. Если нет — добавить минимально необходимые.

### 2.1 Карточка детально
- `GET /api/cards/:id` → возвращает карточку **с расширениями**:
  - base поля (title, description, priority, due_at, column_id, etc.)
  - `assignees: [{id, name, avatar_url?}]`
  - `labels: [{id, name, color}]`
  - `checklist: [{id, title, done, sort}]`
  - `comments: [{id, author, text, created_at}]`

### 2.2 Частичное обновление карточки
- `PATCH /api/cards/:id` → принимает любые поля из:
  - title, description, priority, due_at
- Ответ возвращает обновлённую карточку (или статус ok).

### 2.3 Assignees
- Вариант А (проще, предпочтительно):
  - `PUT /api/cards/:id/assignees` body: `{ user_ids: string[] }`
- Вариант B:
  - `POST /api/cards/:id/assignees` body: `{ user_id }`
  - `DELETE /api/cards/:id/assignees/:user_id`

### 2.4 Labels
- `GET /api/labels?board_id=...`
- `POST /api/labels` body: `{ board_id, name, color }`
- `PUT /api/cards/:id/labels` body: `{ label_ids: string[] }`

### 2.5 Checklist
- `GET /api/cards/:id/checklist`
- `POST /api/cards/:id/checklist` body: `{ title }`
- `PATCH /api/checklist/:item_id` body: `{ title?, done?, sort? }`
- `DELETE /api/checklist/:item_id`

### 2.6 Comments
- `GET /api/cards/:id/comments`
- `POST /api/cards/:id/comments` body: `{ text }`

### 2.7 Users lookup
- `GET /api/users?query=...&limit=...` → список пользователей для назначения.

---

## 3) Frontend: конкретные указания реализации

### 3.1 Drawer (Offcanvas)
- Использовать Bootstrap Offcanvas (или эквивалент в текущем стеке).
- Внутри: Tabs + контент.
- Держать выбранную карточку в состоянии (например, `selectedCardId`).

### 3.2 Auto-save
Реализовать единый механизм:
- `useAutoSave(fieldValue, saveFn, {debounceMs: 400})`
- Сохранение на `onChange` (debounce) и на `onBlur`.
- Визуальный статус: `idle/saving/saved/error`.

### 3.3 Assignees UI
- Chips/avatars + кнопка “+”.
- Dropdown с поиском:
  - при вводе — запрос к `/api/users?query=...` (debounce 250–400 мс).
- Клик по пользователю добавляет/удаляет из списка, сразу вызывает сохранение.

### 3.4 Labels UI
- Chips/badges цветные.
- “+ Метка” → список доступных + “Создать”.
- Создание: name + color enum.
- Сохранение по выбору/снятию — сразу.

### 3.5 Checklist UI
- Список пунктов с checkbox.
- Добавление через input + кнопка (auto-save).
- На карточке показывать прогресс (done/total).

### 3.6 Приоритет и дедлайн
- Priority: select или segmented.
- Due: datetime-local.
- Сразу сохранять, отражать в карточке на доске.

---

## 4) Ограничения и анти-ошибки (важно)

1) **Не требовать Enter** для применения правок. Enter может быть шорткатом, но не “обязательным”.
2) Не делать “отдельные страницы” для карточки — всё через Drawer.
3) Не ломать DnD активной доски: Drawer/auto-save не должны перерисовывать весь список.
4) Если где-то применяется виртуализация списка — **на активной доске с DnD виртуализацию не включать** (известный конфликт с @dnd-kit). Виртуализация допустима только в архиве/поиске.
5) Не логировать секреты/токены/внутренние заголовки.

---

## 5) Чек-лист проверки (для финального самотеста агента)

- [ ] Клик по карточке открывает Drawer справа
- [ ] В Drawer есть вкладки: Чат, Описание, Подзадачи, Инфо/Лог
- [ ] Title/Description меняются и сохраняются без Enter
- [ ] Priority/Due меняются и сохраняются, переживают refresh
- [ ] Исполнители выбираются из БД через поиск, отображаются аватарками
- [ ] Метки добавляются/создаются/удаляются, отображаются цветными
- [ ] Подзадачи работают CRUD + прогресс на карточке
- [ ] Комментарии отправляются и отображаются, есть обновление (polling)
- [ ] DnD на активной доске не сломан

---

## 6) Формат результата
- Прямые изменения в текущем репозитории проекта.
- В конце агент даёт отчёт:
  - какие файлы изменены,
  - какие эндпоинты добавлены/использованы,
  - как руками проверить сценарии из чек-листа.

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Редактирование DOCX</title>
    <script src="http://localhost:8081/web-apps/apps/api/documents/api.js"></script>
</head>
<body>
<div id="editor" style="width: 100%; height: 600px;"></div>

<script>
    {# Один ключ на сессию — нужен для кнопки «Сохранить» и для сохранения при уходе со страницы #}
    const docKey = "{{ docKey|e('js') }}";
    const triggerSaveUrl = "{{ path('app_trigger_forcesave')|e('js') }}";

    const docEditor = new DocsAPI.DocEditor("editor", {
        width: "100%",
        height: "600px",
        type: "desktop",
        document: {
            fileType: "docx",
            key: docKey,
            title: "{{ filename|e('js') }}",
            url: "http://nginx/uploads/documents/originals/doc.docx?v={{ documentVersion|e('js') }}"
        },
        editorConfig: {
            callbackUrl: "http://nginx/save_docx",
            autosave: true,
            autosaveInterval: 2,
            customization: {
                forcesave: true   // кнопка «Сохранить» в панели OnlyOffice — сразу шлёт callback
            }
        }
    });

    // Сохранение при уходе со страницы (закрытие вкладки, переход, перезагрузка)
    window.addEventListener("beforeunload", function () {
        navigator.sendBeacon(triggerSaveUrl, new Blob([JSON.stringify({ key: docKey })], { type: "application/json" }));
    });
</script>
</body>
</html>

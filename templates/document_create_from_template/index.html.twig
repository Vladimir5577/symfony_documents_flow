<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Редактор документа</title>

    <style>
        /* A4: 210×297 mm, отступы по ГОСТ 2.0 см */
        :root {
            --a4-width: 210mm;
            --a4-height: 297mm;
            --a4-margin: 20mm;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px auto;
            background: #e8e8e8;
        }

        .page-a4 {
            width: var(--a4-width);
            min-height: var(--a4-height);
            margin: 0 auto;
            padding: var(--a4-margin);
            box-sizing: border-box;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,.15);
            position: relative;
        }

        #editor-container {
            position: relative;
            width: 100%;
            height: calc(var(--a4-height) - 2 * var(--a4-margin));
            min-height: 0;
            overflow: hidden;
            background: #fff;
        }

        .block {
            position: absolute;
            border: 1px dashed #888;
            padding: 0;
            cursor: move;
            margin: 0;
            user-select: text;
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.35;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            overflow: hidden;
            box-sizing: border-box;
        }

        .save-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 16px;
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        @media print {
            @page { size: A4; margin: 0; }
            body { margin: 0; background: #fff; }
            .page-a4 { box-shadow: none; margin: 0; }
            .save-btn { display: none !important; }
        }
    </style>
</head>
<body>

<div class="page-a4">
    <div id="editor-container">
        <p class="block" contenteditable="true" style="top: 1mm; left: 100mm; max-width: 70mm; max-height: 247mm;">ФИО: Иванов Иван Иванович</p>
        <h2 class="block" contenteditable="true" style="top: 70mm; left: 70mm; max-width: 100mm; max-height: 187mm;">ЗАЯВЛЕНИЕ</h2>
        <p class="block" contenteditable="true" style="top: 80mm; left: 20mm; max-width: 170mm; max-height: 177mm;">
            Прошу принять меня на работу. Можно написать несколько строк текста, чтобы проверить перенос и корректное отображение после сохранения.
        </p>
        <p class="block" contenteditable="true" style="top: 200mm; left: 20mm; max-width: 170mm; max-height: 57mm;">Дата: 03.02.2026</p>
    </div>
</div>

<button class="save-btn">Сохранить HTML</button>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<script>
    // Область печати: 170×257 mm (A4 минус отступы)
    const CONTENT_W_MM = 170;
    const CONTENT_H_MM = 257;

    function updateBlockBounds(block) {
        const top = parseFloat(block.style.top) || 0;
        const left = parseFloat(block.style.left) || 0;
        const topMm = String(block.style.top).endsWith('mm') ? top : top / 3.78;
        const leftMm = String(block.style.left).endsWith('mm') ? left : left / 3.78;
        block.style.maxWidth = (CONTENT_W_MM - leftMm) + 'mm';
        block.style.maxHeight = (CONTENT_H_MM - topMm) + 'mm';
    }

    document.querySelectorAll('.block').forEach(updateBlockBounds);

    // Enter внутри блока вставляет <br>, а не новый блок — строки не «уезжают» влево
    document.querySelectorAll('.block').forEach(block => {
        block.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.execCommand('insertLineBreak');
            }
        });
    });

    // Перетаскивание блоков
    interact('.block').draggable({
        inertia: true,
        modifiers: [
            interact.modifiers.restrictRect({
                restriction: 'parent',
                endOnly: true
            })
        ],
        listeners: {
            move(event) {
                const target = event.target;
                let top = parseFloat(target.style.top) || 0;
                let left = parseFloat(target.style.left) || 0;
                const inMm = String(target.style.top).endsWith('mm');
                if (inMm) {
                    top += event.dy / 3.78;
                    left += event.dx / 3.78;
                } else {
                    top += event.dy;
                    left += event.dx;
                }
                target.style.top = top + (inMm ? 'mm' : 'px');
                target.style.left = left + (inMm ? 'mm' : 'px');
                updateBlockBounds(target);
            }
        }
    });

    // Сохранение HTML без рамок и редактирования
    document.querySelector('.save-btn').addEventListener('click', () => {
        const container = document.getElementById('editor-container');
        const clone = container.cloneNode(true);

        clone.querySelectorAll('.block').forEach(block => {
            block.removeAttribute('contenteditable');
            block.style.border = 'none';
            block.style.width = '';
            block.style.height = '';
            // Вложенные блоки (div/p) от прошлых Enter — в <br>, чтобы строки не уезжали влево
            Array.from(block.querySelectorAll('div, p')).forEach(el => {
                const br = document.createElement('br');
                el.parentNode.insertBefore(br, el);
                el.replaceWith(...el.childNodes);
            });
        });

        // Стили для сохранённого документа — A4 с отступами
        const style = `
      <style>
        @page { size: A4; margin: 20mm; }
        body { margin: 0; font-family: Arial, sans-serif; background: #e8e8e8; padding: 20px 0; }
        .page-a4 {
          width: 210mm;
          min-height: 297mm;
          padding: 20mm;
          box-sizing: border-box;
          margin: 0 auto;
          background: #fff;
          border: 1px solid #999;
          box-shadow: 0 2px 10px rgba(0,0,0,.15);
        }
        #editor-container {
          position: relative;
          height: 257mm;
          overflow: hidden;
        }
        .block {
          position: absolute;
          padding: 0;
          margin: 0;
          font-family: Arial, sans-serif;
          font-size: 14px;
          line-height: 1.35;
          white-space: pre-wrap;
          overflow-wrap: break-word;
          word-wrap: break-word;
          word-break: break-word;
          overflow: hidden;
          box-sizing: border-box;
        }
        @media print {
          body { background: #fff; padding: 0; }
          .page-a4 { border: none; box-shadow: none; }
        }
      </style>
    `;

        const html = style + '<div class="page-a4"><div id="editor-container">' + clone.innerHTML + '</div></div>';

        // AJAX-запрос на сервер
        fetch('/document_save_from_template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ html })
        })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok'){
                    alert('Документ успешно сохранён!');
                } else {
                    alert('Ошибка при сохранении: ' + (data.message || ''));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Ошибка соединения с сервером.');
            });
    });
</script>

</body>
</html>

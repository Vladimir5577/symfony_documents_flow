<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('user-search');
        const clearBtn = document.getElementById('user-search-clear');
        const tableBody = document.querySelector('table.table-hover tbody');
        const cardHeader = document.querySelector('.card-header .text-muted');
        const paginationContainer = document.querySelector('.card-body nav')?.closest('.card-body');
        let debounceTimer;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function buildPagination(pagination, search) {
            if (pagination.total_pages <= 1) return '';

            const cp = pagination.current_page;
            const tp = pagination.total_pages;
            const ipp = pagination.items_per_page;
            const ti = pagination.total_items;

            let startPage = Math.max(1, cp - 2);
            let endPage = Math.min(tp, cp + 2);

            let html = '<nav aria-label="Навигация по страницам"><ul class="pagination justify-content-center mb-0">';

            // Prev
            html += '<li class="page-item ' + (cp === 1 ? 'disabled' : '') + '">';
            html += '<a class="page-link" href="#" data-page="' + (cp > 1 ? cp - 1 : 1) + '" aria-label="Предыдущая"><span aria-hidden="true">&laquo;</span></a></li>';

            if (startPage > 1) {
                html += '<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>';
                if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }

            for (let p = startPage; p <= endPage; p++) {
                html += '<li class="page-item ' + (p === cp ? 'active' : '') + '"><a class="page-link" href="#" data-page="' + p + '">' + p + '</a></li>';
            }

            if (endPage < tp) {
                if (endPage < tp - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                html += '<li class="page-item"><a class="page-link" href="#" data-page="' + tp + '">' + tp + '</a></li>';
            }

            // Next
            html += '<li class="page-item ' + (cp === tp ? 'disabled' : '') + '">';
            html += '<a class="page-link" href="#" data-page="' + (cp < tp ? cp + 1 : tp) + '" aria-label="Следующая"><span aria-hidden="true">&raquo;</span></a></li>';

            html += '</ul></nav>';
            html += '<div class="text-center mt-2"><small class="text-muted">';
            html += 'Страница ' + cp + ' из ' + tp + ' (показано ' + (((cp - 1) * ipp) + 1) + ' - ' + Math.min(cp * ipp, ti) + ' из ' + ti + ')';
            html += '</small></div>';

            return html;
        }

        function doSearch(page) {
            const search = searchInput.value.trim();
            let params = 'search=' + encodeURIComponent(search) + '&page=' + (page || 1);
            const orgEl = document.getElementById('filter-organization-id');
            const statusEl = document.getElementById('filter-status-select');
            if (orgEl && orgEl.value) params += '&organization_id=' + encodeURIComponent(orgEl.value);
            if (statusEl && statusEl.value) params += '&status=' + encodeURIComponent(statusEl.value);
            const url = '{{ path("app_users_search") }}' + '?' + params;

            clearBtn.classList.toggle('d-none', search === '');

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    let rows = '';
                    if (data.users.length > 0) {
                        data.users.forEach(function (u) {
                            rows += '<tr data-user-id="' + escapeHtml(String(u.id)) + '" role="button" tabindex="0">';
                            rows += '<td class="text-bold-500">' + escapeHtml(String(u.id)) + '</td>';
                            rows += '<td>' + escapeHtml(u.lastname) + '</td>';
                            rows += '<td>' + escapeHtml(u.firstname) + '</td>';
                            rows += '<td>' + escapeHtml(u.patronymic) + '</td>';
                            rows += '<td>' + escapeHtml(u.phone) + '</td>';
                            rows += '<td><span class="badge bg-secondary">' + escapeHtml(u.userEmployeeStatusLabel || '') + '</span></td>';
                            rows += '</tr>';
                        });
                    } else {
                        rows = '<tr><td colspan="6" class="text-center">Пользователи не найдены</td></tr>';
                    }

                    tableBody.innerHTML = rows;
                    cardHeader.textContent = 'Всего пользователей: ' + data.pagination.total_items;

                    // Update pagination
                    let pagWrapper = document.getElementById('ajax-pagination');
                    if (!pagWrapper) {
                        pagWrapper = document.createElement('div');
                        pagWrapper.id = 'ajax-pagination';
                        tableBody.closest('.card-content').appendChild(pagWrapper);
                    }

                    // Hide the original server-rendered pagination
                    if (paginationContainer) paginationContainer.style.display = 'none';

                    pagWrapper.innerHTML = data.pagination.total_pages > 1
                        ? '<div class="card-body">' + buildPagination(data.pagination, search) + '</div>'
                        : '';
                });
        }

        searchInput.addEventListener('input', function () {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function () { doSearch(1); }, 300);
        });

        clearBtn.addEventListener('click', function () {
            searchInput.value = '';
            clearBtn.classList.add('d-none');
            doSearch(1);
            searchInput.focus();
        });

        // Delegate pagination clicks
        document.addEventListener('click', function (e) {
            const link = e.target.closest('#ajax-pagination a[data-page]');
            if (link) {
                e.preventDefault();
                doSearch(parseInt(link.dataset.page, 10));
            }
        });
    });
</script>

{% extends 'base_dashboard.html.twig' %}

{% block title %}Организации!{% endblock %}



{% block sidebar_list %}
    {% include 'sidebar/sidebar_list.html.twig' %}
{% endblock %}



{% block main %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Все организации</h1>
        {% if is_granted('ROLE_ADMIN') %}
            <a href="{{ path('create_organization') }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Создать организацию
            </a>
        {% endif %}
    </div>

    <div class="mb-3">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="org-search" class="form-control" placeholder="Поиск по названию, адресу, телефону, email..." value="{{ search|default('') }}" autocomplete="off">
            <button type="button" id="org-search-clear" class="btn btn-outline-secondary {% if not search|default('') %}d-none{% endif %}">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    <section class="section">
        <div class="row" id="table-hover-row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Список организаций</h4>
                        <p class="text-muted">Всего организаций: {{ pagination.total_items }}</p>
                    </div>
                    <div class="card-content">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Адрес</th>
                                    <th>Телефон</th>
                                    <th>Email</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if organizations|length > 0 %}
                                    {% for organization in organizations %}
                                        <tr data-href="{{ path('view_organization', {id: organization.id}) }}" role="button" tabindex="0">
                                            <td class="text-bold-500">{{ organization.id }}</td>
                                            <td>{{ organization.name }}</td>
                                            <td>{{ organization.address ?? '-' }}</td>
                                            <td>{{ organization.phone ?? '-' }}</td>
                                            <td>{{ organization.email ?? '-' }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">Организации не найдены</td>
                                    </tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>

                        {# Пагинация #}
                        {% if pagination.total_pages > 1 %}
                            <div class="card-body">
                                <nav aria-label="Навигация по страницам">
                                    <ul class="pagination justify-content-center mb-0">
                                        {# Предыдущая страница #}
                                        <li class="page-item {% if pagination.current_page == 1 %}disabled{% endif %}">
                                            <a class="page-link" href="{% if pagination.current_page > 1 %}{{ path('app_all_organizations', {page: pagination.current_page - 1, search: search|default('')}) }}{% else %}#{% endif %}" aria-label="Предыдущая">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>

                                        {# Номера страниц #}
                                        {% set start_page = max(1, pagination.current_page - 2) %}
                                        {% set end_page = min(pagination.total_pages, pagination.current_page + 2) %}

                                        {% if start_page > 1 %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ path('app_all_organizations', {page: 1, search: search|default('')}) }}">1</a>
                                            </li>
                                            {% if start_page > 2 %}
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            {% endif %}
                                        {% endif %}

                                        {% for page in start_page..end_page %}
                                            <li class="page-item {% if page == pagination.current_page %}active{% endif %}">
                                                <a class="page-link" href="{{ path('app_all_organizations', {page: page, search: search|default('')}) }}">{{ page }}</a>
                                            </li>
                                        {% endfor %}

                                        {% if end_page < pagination.total_pages %}
                                            {% if end_page < pagination.total_pages - 1 %}
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            {% endif %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ path('app_all_organizations', {page: pagination.total_pages, search: search|default('')}) }}">{{ pagination.total_pages }}</a>
                                            </li>
                                        {% endif %}

                                        {# Следующая страница #}
                                        <li class="page-item {% if pagination.current_page == pagination.total_pages %}disabled{% endif %}">
                                            <a class="page-link" href="{% if pagination.current_page < pagination.total_pages %}{{ path('app_all_organizations', {page: pagination.current_page + 1, search: search|default('')}) }}{% else %}#{% endif %}" aria-label="Следующая">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-center mt-2">
                                    <small class="text-muted">
                                        Страница {{ pagination.current_page }} из {{ pagination.total_pages }}
                                        (показано {{ ((pagination.current_page - 1) * pagination.items_per_page) + 1 }} - {{ min(pagination.current_page * pagination.items_per_page, pagination.total_items) }} из {{ pagination.total_items }})
                                    </small>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% include 'organization/partials/_script_organization_search.html.twig' %}

    <script>
        document.querySelectorAll('#table-hover-row tr[data-href]').forEach(function(row) {
            row.addEventListener('click', function() { window.location.href = this.dataset.href; });
            row.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); window.location.href = this.dataset.href; }
            });
        });
    </script>
    <style>#table-hover-row tr[data-href] { cursor: pointer; }</style>
{% endblock %}
